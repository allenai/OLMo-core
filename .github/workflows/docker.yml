name: Docker

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:
  # TODO: disabled for now because it takes too long in CI
  pull_request:
    branches:
      - main
    paths:
      - 'Makefile'
      - 'pyproject.toml'
      - 'src/olmo_core/version.py'
      - 'src/Dockerfile'
      - '.github/workflows/docker.yml'
  push:
    # branches:
    #   - main
    tags:
      - 'v*.*.*'

jobs:
  docker:
    name: CUDA ${{ matrix.cuda }} PyTorch ${{ matrix.torch.version }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      BEAKER_TOKEN: ${{ secrets.BEAKER_TOKEN }}
      DOCKER_HUB_TOKEN: ${{ secrets.DOCKER_HUB_TOKEN }}
      DOCKER_HUB_USER: ${{ secrets.DOCKER_HUB_USER }}
      GANTRY_GITHUB_TESTING: "true" # force better logging for CI
    strategy:
      fail-fast: false
      matrix:
        cuda: ["12.8.1", "12.9.1"]  # NOTE: check tags for options: https://hub.docker.com/r/nvidia/cuda/tags
        torch:
          - version: 2.7.1
            channel: whl/test
          - version: 2.9.0
            channel: whl/test
        exclude:
          # Unsupported combination of CUDA and PyTorch version.
          - cuda: "13.0.2"
            torch:
              version: 2.7.1
              channel: whl/test
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - uses: astral-sh/setup-uv@v6
        with:
          python-version: "3.12"

      - name: Install Gantry
        run:
          uv tool install 'beaker-gantry>=3.1,<4.0'

      - name: Determine Beaker workspace
        if: env.BEAKER_TOKEN != ''
        run: |
          echo "BEAKER_WORKSPACE=$(make get-beaker-workspace)" >> $GITHUB_ENV

      - name: Determine current commit SHA (pull request)
        if: github.event_name == 'pull_request'
        run: |
          echo "COMMIT_SHA=${{ github.event.pull_request.head.sha }}" >> $GITHUB_ENV
          echo "BRANCH_NAME=${{ github.head_ref }}" >> $GITHUB_ENV

      - name: Determine current commit SHA (push/workflow_dispatch)
        if: github.event_name != 'pull_request'
        run: |
          echo "COMMIT_SHA=$GITHUB_SHA" >> $GITHUB_ENV
          echo "BRANCH_NAME=${{ github.ref_name }}" >> $GITHUB_ENV

      - name: Determine if tag
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "IS_TAG=true" >> $GITHUB_ENV
          else
            echo "IS_TAG=false" >> $GITHUB_ENV
          fi

      - name: Docker Build
        if: env.BEAKER_TOKEN != ''
        run: |
          gantry run \
            --show-logs \
            --yes \
            --workspace ${{ env.BEAKER_WORKSPACE }} \
            --description 'OLMo-core Docker Build: CUDA ${{ matrix.cuda }} PyTorch ${{ matrix.torch.version }}' \
            --ref ${{ env.COMMIT_SHA }} \
            --branch ${{ env.BRANCH_NAME }} \
            --budget ai2/oe-base \
            --priority normal \
            --preemptible \
            --task-timeout 50m \
            --host-networking \
            --system-python \
            --env-secret 'DOCKER_HUB_TOKEN=DOCKER_HUB_TOKEN' \
            --env-secret 'DOCKER_HUB_USER=DOCKER_HUB_USER' \
            --env-secret 'GITHUB_TOKEN=GITHUB_TOKEN' \
            --env 'GITHUB_ACTOR=${{ github.actor }}' \
            --env 'CUDA_VERSION=${{ matrix.cuda }}' \
            --env 'TORCH_VERSION=${{ matrix.torch.version }}' \
            --env 'INSTALL_CHANNEL=${{ matrix.torch.channel }}' \
            --env "IS_TAG=${{ env.IS_TAG }}" \
            -- bash -c '
              [ -n "${DOCKER_HUB_TOKEN:-}" ] && [ -n "${DOCKER_HUB_USER:-}" ] && echo "${DOCKER_HUB_TOKEN}" | docker login -u "${DOCKER_HUB_USER}" --password-stdin || true
              [ "${IS_TAG}" = "true" ] && [ -n "${GITHUB_TOKEN:-}" ] && echo "${GITHUB_TOKEN}" | docker login ghcr.io -u "${GITHUB_ACTOR}" --password-stdin || true
              make docker-image CUDA_VERSION="${CUDA_VERSION}" TORCH_VERSION="${TORCH_VERSION}" INSTALL_CHANNEL="${INSTALL_CHANNEL}"
              [ "${IS_TAG}" = "true" ] && make ghcr-image CUDA_VERSION="${CUDA_VERSION}" TORCH_VERSION="${TORCH_VERSION}" INSTALL_CHANNEL="${INSTALL_CHANNEL}" || true
              [ "${IS_TAG}" = "true" ] && make beaker-image CUDA_VERSION="${CUDA_VERSION}" TORCH_VERSION="${TORCH_VERSION}" INSTALL_CHANNEL="${INSTALL_CHANNEL}" || true
            '
